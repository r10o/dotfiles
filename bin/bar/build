#!/usr/bin/sh

. config_bar

titt=""
titw=0

timet=""
timew=0

batt=""
batw=0
mpdt=""
mpdw=0

nett=""
netw=0

volt=""
volw=0

wmt=""
wmw=0

layt=""
layw=0

padding="    "
color=""
icon=""

width=""
empty_width=""

IFS=":"
textw=$(txtw -f $font -s $font_size " ")

while read -r line; do
	case $line in
		N*)
			# Network info
			set -- ${line#?}
			essid=$1
			strength=$2
			icon_width=14
			if [[ ! $essid ]]; then
				essid="disconnected"
				color="${red}"
				icon=${net_down}
				icon_width=8
			else
				color="${cyan}"
				if [[ $essid == "usb" ]]; then
					icon=${net_up}
					icon_width=8
				else
					if [[ $strength -le 14 ]]; then
						icon=${wireless1}
					elif [[ $strength -le 28 ]]; then
						icon=${wireless2}
					elif [[ $strength -le 42 ]]; then
						icon=${wireless3}
					elif [[ $strength -le 56 ]]; then
						icon=${wireless4}
					elif [[ $strength -le 70 ]]; then
						icon=${wireless5}
					fi
				fi
			fi
			nett="${color}${icon} ^fg($COLOR_FOREGROUND)${essid}"
			ssidw="$(txtw -f $font -s $font_size $essid)"
			netw=$((icon_width + textw + ssidw))
			;;
		V*)
			# Volume info
			set -- ${line#?}
			mute=$1
			level=$2
			if [[ $mute == "off" ]]; then
				icon="${speaker_off}"
				color="${red}"
			elif [[ $mute == "on" ]]; then
				icon="${speaker_on}"
				color="${cyan}"
			fi
			
			width=$((level / 2))
			empty_width=$((50 - width))

			volt="^ca(1, amixer set Master toggle -q)${color}${icon}^ca() ${white}^r(${width}x1)${grey}^r(${empty_width}x1)"
			volw=$((8 + 50 + textw))
			;;
		B*)
			# Battery info
			count=${line#?}
			level=0
			stat="Charging"

			if [ "$level" -le "5" ]; then
				icon=$battery_empty
				color=$red
			elif [ "$level" -le "30" ]; then
				icon=$battery_low
				color=$yellow
			else
				icon=$battery_full
				color=$cyan
			fi

			if [ "${stat}" == "Charging" ]; then
				width=$((count * 5))
			else
				width=$((level / 2))
			fi

			empty_width=$((50 - width))

			batt="${color}${icon} ${white}^r(${width}x1)${grey}^r(${empty_width}x1)"
			batw=$((8 + 50 + textw))
			;;
		M*)
			# MPD info
			set -- ${line#?}
			title=$1
			stat=$2
			icon=$play

			if [[ $stat == "paused" ]]; then
				icon=$pause
			fi

			if [ "$title" == "stopped" ]; then
				icon=$stopico
				color=$red
			else
				color=$cyan
			fi

			mpdt=" ${color}${icon} ^fg(${COLOR_FOREGROUND})${title}"
			songw="$(txtw -f $font -s $font_size $title)"
			mpdw=$((9 + textw + songw))
			;;
		C*)
			# Time info
			tim=${line#?}
			icon=$clock
			color=$cyan

			timet="^ca(1,/home/rohan/bin/bar/script/cal_app)${color}${icon} ^fg(${COLOR_FOREGROUND})${tim}^ca()"
			timew=$((9 * textw + 8))
			;;
		T*)
			# Window Title info
			title=${line#?}

			titt="${title}"
			titw="$(txtw -f $font -s $font_size "$title")"
			;;
		W*)
			# Window Manager informations
			set -- ${line#?}
			wmt="  "
			while [ $# -gt 0 ] ; do
				item=$1
				case $item in
					[OoFfUu]*)
						# desktops
						name=${item#?}
						case $item in
							[OFU]*)
								# active desktop
								FG=$COLOR_ACTIVE_FG
								BG=$COLOR_ACTIVE_BG
								;;
							o*)
								# inactive desktop
								FG=$COLOR_INACTIVE_FG
								BG=$COLOR_INACTIVE_BG
								;;
							f*)
								# empty desktop
								FG=$COLOR_EMPTY_FG
								BG=$COLOR_EMPTY_BG
								;;
							u*)
								# urgent desktop
								FG=$COLOR_URGENT_FG
								BG=$COLOR_URGENT_BG
								;;
						esac
						wmt="$wmt^ca(1, bspc desktop -f ${name})^ca(2, bspc window -d ${name})^ca(3, bspc window -d ${name} -f)^fg($FG)^bg($BG) $name ^fg()^bg()^ca()^ca()^ca()"
						;;
					L*)
						layt="^ca(1, bspc desktop -l next)^fg($COLOR_FOREGROUND)| $(echo ${item#?} | sed 's|^\(.\).*|\U\1|') |^ca()"
						;;
				esac
				shift
			done
			;;
	esac
	ypos=$((1366 - (mpdw + netw + batw + volw + timew + textw * 4 * 4 + textw * 3)))
	echo -e "${wmt} ${layt}  ${titt}^pa($ypos)${mpdt}${padding}${nett}${padding}${batt}${padding}${volt}${padding}${timet}"
done
