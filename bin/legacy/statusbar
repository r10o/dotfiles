#!/usr/bin/sh

. bar_apps/config

# Counter
count="0"
spacing="    "

getMpd() {
	running="$(ps aux | grep '[\d] mpd')"
	title="error"
	color="${red}"

	if [ -n "${running}" ]; then
		color=${red}
		title="stopped"
	else
		title="$(mpc current -f %title%)"
		if [ -z "${title}" ]; then
			color=${red}
			title="stopped"
		else
			color=${cyan}
		fi
	fi

	echo -ne "${color}${note} ${white}${title}"
}

getVolume() {
	mute="$(amixer get Master | sed '1,4d;s|.*\[\(.*\)\]$|\1|')"
        color="${red}"

        if [ $mute == "off" ]; then
		icon="${speaker_off}"
                color="${red}"
	elif [ $mute == "on" ]; then
		icon="${speaker_on}"
		color="${cyan}"
	fi

	volume="$(amixer get Master | sed '1,4d;s|.*\[\(.*\)%\].*|\1|')"
	vol_width=$((volume / 2))
	empty_width=$((50 - vol_width))

	echo -ne "${color}${icon} ${white}^r(${vol_width}x1)${grey}^r(${empty_width}x1)"
}

getNet() {
        current="$(essid -w wlo1)"
	color="${red}"

	if [ -z $current ]; then
		current="disconnected"
		color="${red}"
                icon=${net_down}
	else
		color="${cyan}"
		if [[ $current == 'usb' ]]; then
			icon=${net_up}
		else
			quality="$(cat /proc/net/wireless | sed '1,2d;s|.*\s\([0-9]*\)\..*|\1|')"
			if [[ $quality -le 14 ]]; then
				icon=${wireless1}
			elif [[ $quality -le 28 ]]; then
				icon=${wireless2}
			elif [[ $quality -le 42 ]]; then
				icon=${wireless3}
			elif [[ $quality -le 56 ]]; then
				icon=${wireless4}
			elif [[ $quality -le 70 ]]; then
				icon=${wireless5}
			fi
		fi
	fi

	echo -ne "${color}${icon} ${white}${current}"
}

getBattery() {
	level="$(acpi | sed 's|.* \([0-9]*\)%.*|\1|')"
	charging="$(acpi | sed 's|.*: \([A-Za-z]*\).*|\1|')"
        color=${cyan}

	if [ -z "${level}" ]; then
		level=0
		charging="Charging"
	fi

	if [ "${level}" -le "5" ]; then
		icon=${battery_empty}
		color=${red}
	elif [ "${level}" -le "30" ]; then
		icon=${battery_low}
		color=${yellow}
	else
		icon=${battery_full}
		color=${cyan}
	fi

        if [ "${charging}" == "Charging" ]; then
		bat_width=$((count * 5))
        else
		bat_width=$((level / 2))
        fi

	empty_width=$((50 - bat_width))

	echo -ne "${color}${icon} ${white}^r(${bat_width}x1)${grey}^r(${empty_width}x1)"
}

getDate() {
	icon=${grid}
	echo -ne "${cyan}${icon} ${white}$(date "+%B %e, %Y")"
}

getTime() {
	icon=${clock}
        echo -ne "${cyan}${clock} ${white}$(date "+%I:%M %p")"
}

while true; do
	echo -e "S$(getMpd)${spacing}$(getVolume)${spacing}$(getBattery)${spacing}$(getNet)${spacing}$(getDate)${spacing}$(getTime) "
	if [ "${count}" -lt "10" ]; then
		((count++))
	else
		count="0"
	fi
	sleep 1
done
